<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Spiral Milky Way + Solar System</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
#ui{
  position:fixed;left:16px;top:16px;
  background:rgba(0,0,0,.45);
  color:#fff;padding:10px 12px;
  font-family:system-ui;border-radius:10px;
}
canvas{display:block}
</style>
</head>
<body>

<div id="ui">
<b>Milky Way (Cinematic)</b><br>
✋ Pinch = Zoom<br>
✋ Move palm = Rotate
</div>

<video id="cam" autoplay playsinline style="display:none"></video>

<script type="importmap">
{
  "imports":{
    "three":"https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from
"https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/controls/OrbitControls.js";

/* ================= BASIC ================= */
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x000005);

const camera=new THREE.PerspectiveCamera(50,innerWidth/innerHeight,0.1,8000);
camera.position.set(0,120,380);

const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;
controls.minDistance=50;
controls.maxDistance=2000;

/* ================= ROOT ================= */
const galaxyRoot=new THREE.Group();
scene.add(galaxyRoot);

/* ================= TEXTURES ================= */
const tl=new THREE.TextureLoader();
const starTex=tl.load("https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/textures/sprites/disc.png");
const glowTex=tl.load("https://threejs.org/examples/textures/lensflare/lensflare0.png");

/* ================= SPIRAL MILKY WAY ================= */
function createSpiralGalaxy(){
  const arms=4;
  const pointsPerArm=6000;
  const radius=1400;

  const positions=[];
  const colors=[];

  for(let a=0;a<arms;a++){
    const armOffset=(a/arms)*Math.PI*2;
    for(let i=0;i<pointsPerArm;i++){
      const t=i/pointsPerArm;
      const angle=t*6 + armOffset;
      const r=t*radius + Math.random()*40;

      const x=Math.cos(angle)*r;
      const z=Math.sin(angle)*r;
      const y=(Math.random()-0.5)*60*Math.exp(-t*2);

      positions.push(x,y,z);

      // color gradient (blue -> pink -> white)
      const c=new THREE.Color();
      c.setHSL(
        0.65 - t*0.4,
        0.7,
        0.6 + (1-t)*0.25
      );
      colors.push(c.r,c.g,c.b);
    }
  }

  const g=new THREE.BufferGeometry();
  g.setAttribute("position",new THREE.Float32BufferAttribute(positions,3));
  g.setAttribute("color",new THREE.Float32BufferAttribute(colors,3));

  const mat=new THREE.PointsMaterial({
    size:1.2,
    vertexColors:true,
    transparent:true,
    blending:THREE.AdditiveBlending,
    depthWrite:false
  });

  galaxyRoot.add(new THREE.Points(g,mat));
}

/* ================= CORE GLOW ================= */
function createCoreGlow(){
  for(let i=0;i<12;i++){
    const s=new THREE.Sprite(
      new THREE.SpriteMaterial({
        map:glowTex,
        color:0xfff2cc,
        transparent:true,
        blending:THREE.AdditiveBlending,
        opacity:0.25
      })
    );
    const scale=300 + i*180;
    s.scale.set(scale,scale,1);
    galaxyRoot.add(s);
  }
}

/* ================= DUST CLOUDS ================= */
function createDust(){
  const count=2000;
  const pos=[];
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const r=300+Math.random()*1000;
    pos.push(
      Math.cos(a)*r,
      (Math.random()-0.5)*120,
      Math.sin(a)*r
    );
  }
  const g=new THREE.BufferGeometry();
  g.setAttribute("position",new THREE.Float32BufferAttribute(pos,3));

  galaxyRoot.add(new THREE.Points(
    g,
    new THREE.PointsMaterial({
      size:18,
      map:starTex,
      transparent:true,
      opacity:0.08,
      color:0x8899ff,
      depthWrite:false
    })
  ));
}

createSpiralGalaxy();
createCoreGlow();
createDust();

/* ================= SOLAR SYSTEM ================= */
const sun=new THREE.Mesh(
  new THREE.SphereGeometry(14,48,32),
  new THREE.MeshBasicMaterial({
    map:tl.load("https://diwakarasd.github.io/galaxy-textures/2k_sun.jpg")
  })
);
galaxyRoot.add(sun);

const sunGlow=new THREE.Sprite(
  new THREE.SpriteMaterial({
    map:glowTex,
    color:0xffcc88,
    blending:THREE.AdditiveBlending,
    opacity:0.6
  })
);
sunGlow.scale.set(160,160,1);
galaxyRoot.add(sunGlow);

/* ================= HAND GESTURES (SAFE) ================= */
let scale=1,rx=0,ry=0;
const lowMem=navigator.deviceMemory && navigator.deviceMemory<=4;

function initHands(){
  if(lowMem) return;
  if(typeof Hands==="undefined") return setTimeout(initHands,150);

  const hands=new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });
  hands.setOptions({maxNumHands:1});
  hands.onResults(r=>{
    if(!r.multiHandLandmarks) return;
    const lm=r.multiHandLandmarks[0];
    const d=Math.hypot(lm[4].x-lm[8].x,lm[4].y-lm[8].y);
    scale+=(0.7+d*5-scale)*0.12;
    rx+=((lm[5].y-.5)-rx)*0.08;
    ry+=((lm[5].x-.5)-ry)*0.08;
  });

  new Camera(cam,{
    onFrame:async()=>hands.send({image:cam})
  }).start();
}
initHands();

/* ================= ANIMATE ================= */
function animate(){
  requestAnimationFrame(animate);

  galaxyRoot.rotation.y+=0.00015;
  galaxyRoot.scale.lerp(new THREE.Vector3(scale,scale,scale),0.08);
  galaxyRoot.rotation.x+=(rx-galaxyRoot.rotation.x)*0.05;
  galaxyRoot.rotation.y+=(ry-galaxyRoot.rotation.y)*0.05;

  controls.update();
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</body>
</html>
