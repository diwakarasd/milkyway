<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Solar System inside 3D Milky Way</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
#ui{
  position:fixed;top:12px;left:12px;z-index:10;
  color:#fff;font-family:system-ui;
  background:rgba(0,0,0,.45);
  padding:10px;border-radius:8px;
}
canvas{display:block}
</style>
</head>
<body>

<div id="ui">ðŸŒ€ Solar System inside Milky Way</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/controls/OrbitControls.js";
import { hipparcos_6_5 } from "./hipparcos_6.5_concise.js";

/* ================= RENDERER ================= */
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
document.body.appendChild(renderer.domElement);

/* ================= SCENE & CAMERA ================= */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000008);

const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 8000);
camera.position.set(-760, 40, 360);   // ðŸ‘ˆ START NEAR SOLAR SYSTEM

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.target.set(-800, 20, 300);

/* ================= LIGHT ================= */
scene.add(new THREE.AmbientLight(0x222233, 1));

/* ================= HELPERS ================= */
function raDecToVec3(raDeg, decDeg, r=1600){
  const ra = THREE.MathUtils.degToRad(raDeg);
  const dec = THREE.MathUtils.degToRad(decDeg);
  return new THREE.Vector3(
    r*Math.cos(dec)*Math.cos(ra),
    r*Math.sin(dec),
    r*Math.cos(dec)*Math.sin(ra)
  );
}

/* ================= GALAXY ROOT ================= */
const galaxyRoot = new THREE.Group();
scene.add(galaxyRoot);

/* ================================================= */
/* ================= SOLAR SYSTEM ================= */
/* ================================================= */

const solarSystem = new THREE.Group();
solarSystem.position.set(-800, 20, 300);
galaxyRoot.add(solarSystem);

const tl = new THREE.TextureLoader();
const T = {
  sun: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_sun.jpg"),
  mercury: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_mercury.jpg"),
  venus: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_venus_surface.jpg"),
  earth: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_earth_daymap.jpg"),
  mars: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_mars.jpg"),
  jupiter: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_jupiter.jpg"),
  saturn: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_saturn.jpg"),
  saturnRing: tl.load("https://diwakarasd.github.io/galaxy-textures/2k_saturn_ring_alpha.png")
};

/* ---- Sun ---- */
const sun = new THREE.Mesh(
  new THREE.SphereGeometry(12, 48, 32),
  new THREE.MeshBasicMaterial({ map: T.sun })
);
solarSystem.add(sun);

const sunLight = new THREE.PointLight(0xffffff, 6, 2000);
solarSystem.add(sunLight);

/* ---- Sun glow ---- */
const glow = new THREE.Sprite(
  new THREE.SpriteMaterial({
    map: tl.load("https://threejs.org/examples/textures/lensflare/lensflare0.png"),
    color: 0xffcc66,
    transparent:true,
    blending:THREE.AdditiveBlending
  })
);
glow.scale.set(120,120,1);
sun.add(glow);

/* ---- Planets ---- */
function createPlanet(size, dist, speed, texture, ring=false){
  const pivot = new THREE.Object3D();
  solarSystem.add(pivot);

  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(size,48,32),
    new THREE.MeshPhongMaterial({ map:texture, shininess:15 })
  );
  mesh.position.x = dist;
  pivot.add(mesh);

  if(ring){
    const r = new THREE.Mesh(
      new THREE.RingGeometry(size*1.4, size*2.4, 64),
      new THREE.MeshBasicMaterial({
        map:T.saturnRing,
        transparent:true,
        side:THREE.DoubleSide
      })
    );
    r.rotation.x = Math.PI/2;
    mesh.add(r);
  }

  return { pivot, speed };
}

const planets = [
  createPlanet(1,18,0.02,T.mercury),
  createPlanet(2,26,0.015,T.venus),
  createPlanet(2.2,34,0.01,T.earth),
  createPlanet(1.8,42,0.008,T.mars),
  createPlanet(5,58,0.004,T.jupiter),
  createPlanet(4.5,76,0.003,T.saturn,true)
];

/* ================================================= */
/* ============ REAL 3D MILKY WAY (VOLUME) ========= */
/* ================================================= */

function createMilkyWayVolume(){
  const pos=[], col=[];
  const count = 20000;

  for(let i=0;i<count;i++){
    const r = 2000 * Math.sqrt(Math.random());
    const angle = Math.random()*Math.PI*2;
    const height = (Math.random()-0.5) * 200; // thickness

    const x = Math.cos(angle)*r;
    const z = Math.sin(angle)*r;
    const y = height * Math.exp(-r/1800);

    pos.push(x,y,z);

    const c = 0.6 + Math.random()*0.4;
    col.push(c*0.8, c*0.85, c);
  }

  const g = new THREE.BufferGeometry();
  g.setAttribute("position", new THREE.Float32BufferAttribute(pos,3));
  g.setAttribute("color", new THREE.Float32BufferAttribute(col,3));

  const p = new THREE.Points(
    g,
    new THREE.PointsMaterial({
      size:2,
      vertexColors:true,
      transparent:true,
      opacity:0.6,
      depthWrite:false
    })
  );
  galaxyRoot.add(p);
}
createMilkyWayVolume();

/* ================= HIPPARCOS STAR SPHERE ================= */
function loadStars(){
  const pos=[], col=[];
  hipparcos_6_5.forEach(s=>{
    const v = raDecToVec3(s[2], s[3]);
    pos.push(v.x,v.y,v.z);
    const b = Math.max(0.2,1.6-s[1]*0.35);
    col.push(b,b,b);
  });

  const g = new THREE.BufferGeometry();
  g.setAttribute("position", new THREE.Float32BufferAttribute(pos,3));
  g.setAttribute("color", new THREE.Float32BufferAttribute(col,3));

  galaxyRoot.add(new THREE.Points(
    g,
    new THREE.PointsMaterial({
      size:1.2,
      vertexColors:true,
      transparent:true,
      depthWrite:false
    })
  ));
}
loadStars();

/* ================= HAND GESTURES ================= */
let scale = 1, rx = 0, ry = 0;
let handBusy = false;

function initHands() {
  if (!window.Hands || !window.Camera) {
    requestAnimationFrame(initHands);
    return;
  }

  const video = document.createElement("video");
  video.style.display = "none";
  video.playsInline = true;
  document.body.appendChild(video);

  const hands = new Hands({
    locateFile: f =>
      `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  // ðŸ”’ SAFER SETTINGS (avoid SIMD crash)
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 0,
    selfieMode: true
  });

  hands.onResults(results => {
    handBusy = false;

    if (!results.multiHandLandmarks) return;

    const lm = results.multiHandLandmarks[0];
    const pinch = Math.hypot(
      lm[4].x - lm[8].x,
      lm[4].y - lm[8].y
    );

    scale += ((0.7 + pinch * 4) - scale) * 0.08;
    rx += (lm[5].y - 0.5 - rx) * 0.05;
    ry += (lm[5].x - 0.5 - ry) * 0.05;
  });

  const cameraUtil = new Camera(video, {
    onFrame: async () => {
      // ðŸ”’ CRITICAL GUARD
      if (handBusy || video.readyState < 2) return;

      handBusy = true;
      try {
        await hands.send({ image: video });
      } catch (e) {
        console.warn("MediaPipe hands crashed, disabling gestures");
        cameraUtil.stop();
      }
    },
    width: 640,
    height: 480
  });

  cameraUtil.start();
}

initHands();

/* ================= ANIMATE ================= */
function animate(){
  requestAnimationFrame(animate);

  planets.forEach(p=>p.pivot.rotation.y+=p.speed);

  galaxyRoot.scale.lerp(new THREE.Vector3(scale,scale,scale),0.08);
  galaxyRoot.rotation.x += (rx-galaxyRoot.rotation.x)*0.05;
  galaxyRoot.rotation.y += (ry-galaxyRoot.rotation.y)*0.05;

  controls.update();
  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

</body>
</html>
